<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns=""
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        require-authentication="true" default-menu-title="Quote / Order Detail" default-menu-include="false">

    <parameter name="orderId" required="true"/>
    <!-- Shipping options not necessary for subscriptions. Leaving code here in case required for physical goods
    <transition name="getShippingOptions"><parameter name="orderId"/><parameter name="orderPartSeqId"/><actions>
        <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/>
        <service-call name="mantle.product.StoreServices.get#StoreShippingOptions" out-map="shipOptsOut"
                      in-map="[productStoreId:orderHeader.productStoreId, orderId:orderId, orderPartSeqId:orderPartSeqId,
                            postalContactMechId:postalContactMechId, getRates:true]"/>
        <script>
            outList = []
            for (sop in shipOptsOut.shippingOptions) outList.add([value:"${sop.carrierPartyId}:${sop.shipmentMethodEnumId}".toString(),
            label:"${sop.description ? sop.description : (sop.carrierPartyId != '_NA_' ? (sop.carrierName + ' - ') : '') + sop.shipmentMethodDescription}${sop.shippingTotal != null ? ' ' + ec.l10n.formatCurrency(sop.shippingTotal, orderHeader.currencyUomId) : ''}".toString()])
            ec.web.sendJsonResponse(outList)
        </script>
    </actions><default-response type="none"/></transition>
    -->
    <transition name="setOrderBillingShippingInfo"><service-call name="mantle.order.OrderServices.set#OrderBillingShippingInfo"/>
        <default-response url="."/></transition>
    <transition name="updateShipToParty"><service-call name="sales.SalesOrderServices.update#ShipToParty"/>
        <default-response url="."/></transition>
    <transition name="updateBillToParty"><service-call name="sales.SalesOrderServices.update#BillToParty"/>
        <default-response url="."/></transition>
    <transition name="setBillToContactMech"><service-call name="sales.SalesOrderServices.update#BillToContactMech"/>
        <default-response url="."/></transition>
    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>
    <transition name="updateOrderPart"><service-call name="mantle.order.OrderServices.update#OrderPart"/>
        <default-response url="."/></transition>
    <transition name="addOrderPartPayment"><service-call name="mantle.order.OrderServices.add#OrderPartPayment"/>
        <default-response url="."/></transition>
    <transition name="updatePayment"><service-call name="mantle.account.PaymentServices.update#Payment"/>
        <default-response url="."/></transition>
    <transition name="editPayment"><default-response url="//${appRoot}/Accounting/Payment/EditPayment"/></transition>
    <transition name="gatewayAuthorize"><service-call name="mantle.account.PaymentServices.authorize#SinglePayment"/>
        <default-response url="."/></transition>
    <transition name="placeOrder"><service-call name="mantle.order.OrderServices.place#Order"/>
        <default-response url="."/></transition>
    <transition name="approveOrder"><service-call name="sales.SubscriptionManagementServices.approve#Order" in-map="context + [otherPartyId:customerPartyId]"/>
        <default-response url="."/></transition>
    <transition name="createOrderPartParty"><service-call name="create#mantle.order.OrderPartParty"/>
        <default-response url="."/></transition>
    <transition name="deleteOrderPartParty"><service-call name="delete#mantle.order.OrderPartParty"/>
        <default-response url="."/></transition>

    <subscreens default-item="Item">
        <subscreens-item name="UpdateContactInfo" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdateContactInfo.xml"/>
        <subscreens-item name="UpdatePaymentMethodInfo" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdatePaymentMethodInfo.xml"/>
    </subscreens>

    <pre-actions>
        <service-call name="mantle.order.OrderInfoServices.get#OrderDisplayInfo" in-map="[orderId:orderId, itemLimit:(itemLimit as Integer)]" out-map="context"/>
        <!-- This implementation only supports single part orders. It does not iterate through list of order parts. -->
        <set field="orderPartInfo" from="orderPartInfoList[0]"/>
        <set field="orderPart" from="orderPartInfo.orderPart"/>
        <set field="orderPartSeqId" from="orderPart.orderPartSeqId"/>
        <!-- Check for different ship to and bill to party in OrderPartParty, else use customer on order part -->
        <set field="customerShipToDetail" from="orderPartInfo.customerShipToDetail?:orderPartInfo.customerDetail"/>
        <!-- Check for different bill to party, else use customer on order part -->
        <set field="customerBillToDetail" from="orderPartInfo.customerBillToDetail?:orderPartInfo.customerDetail"/>
        <set field="customerPartyId" from="orderPart.customerPartyId"/>
        <set field="customerShipToPartyId" from="orderPartInfo.customerShipToDetail?.partyId"/>
        <set field="customerBillToPartyId" from="orderPartInfo.customerBillToDetail?.partyId"/>
    </pre-actions>
    <widgets>
        <container-row>
            <row-col lg="6">
                <container-box>
                    <box-header title="Order #${orderId} - ${ec.resource.expand('PartyNameOnlyTemplate','',orderPartInfo.customerDetail)}"/>
                    <box-toolbar>
                        <section name="PlaceSection" condition="orderHeader.statusId in ['OrderOpen', 'OrderProposed', 'OrderBeingChanged', 'OrderHold']"><widgets>
                            <link url="placeOrder" text="Place" link-type="hidden-form" condition="!placeWarnings" style="btn-success"/>
                            <container-dialog id="PlaceOrderDialog" button-text="Place Warnings" condition="placeWarnings" type="success">
                                <section-iterate name="PlaceWarningsSection" list="placeWarnings" entry="placeWarning"><widgets>
                                    <label text="${placeWarning}" type="p"/></widgets></section-iterate>
                                <link url="placeOrder" text="Place Order Anyway" link-type="hidden-form"/>
                            </container-dialog>
                        </widgets></section>
                        <section name="ApproveSection" condition="orderHeader.statusId in ['OrderPlaced', 'OrderProcessing', 'OrderHold']"><widgets>
                            <link url="approveOrder" text="Approve" link-type="hidden-form" style="btn-success" parameter-map="[otherPartyId:orderPart.customerPartyId]"
                                  condition="ec.user.hasPermission('ORDER_APPROVE') &amp;&amp; !approveWarnings"/>
                            <container-dialog id="ApproveOrderDialog" button-text="Approve Warnings" condition="approveWarnings" type="success">
                                <section-iterate name="ApproveWarningsSection" list="approveWarnings" entry="approveWarning"><widgets>
                                    <label text="${approveWarning}" type="p"/></widgets></section-iterate>
                                <link url="approveOrder" text="Approve Order Anyway" link-type="hidden-form"
                                      condition="ec.user.hasPermission('ORDER_APPROVE')"/>
                            </container-dialog>
                        </widgets></section>
                    </box-toolbar>
                    <box-body>
                        <form-single name="HeaderForm" map="orderHeader">
                            <field name="statusId"><default-field title="Status">
                                <display text="${statusItem.description}"/></default-field></field>
                            <field name="entryDate"><default-field title="Created"><display format="yyyy-MM-dd"/></default-field></field>
                            <field name="grandTotal"><default-field><display currency-unit-field="currencyUomId"/></default-field></field>
                            <field-layout>
                                <field-col-row>
                                    <field-col><field-ref name="statusId"/></field-col>
                                    <field-col><field-ref name="entryDate"/></field-col>
                                    <field-col><field-ref name="grandTotal"/></field-col>
                                </field-col-row>
                            </field-layout>
                        </form-single>
                            <label text="Customer Email: ${orderPartInfo.customerEmail ?: 'No Order or Primary email found'}" type="div"/>

                    </box-body>
                </container-box>
                <container-box>
                    <box-header title="Ship To Customer: ${ec.resource.expand('PartyNameOnlyTemplate','',customerShipToDetail)}"/>
                    <box-toolbar>
                        <container-dialog id="ChangeShipToDialog" button-text="Change Ship To" condition="orderPartInfo.partEditable">
                            <form-single name="ChangeShipToForm" transition="updateShipToParty" map="orderPart">
                                <!-- Set role type to ship to for this section -->
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                                <field name="currentShipToPartyId"><default-field><hidden default-value="customerShipToDetail.partyId"/></default-field></field>
                                <field name="newShipToPartyId"><default-field title="Party"><drop-down>
                                    <dynamic-options transition="searchPartyList" server-search="true" min-length="0"/></drop-down>
                                </default-field></field>
                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                        </box-toolbar>
                    <box-body>
                        <section name="CurrentShippingAddress">
                            <actions>
                                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="curShipToInfo"
                                              in-map="[partyId:customerShipToDetail.partyId, postalContactMechId:orderPart.postalContactMechId]"/>
                                <set field="contactInfo" from="curShipToInfo"/>
                                <!-- addresses on profile -->
                                <service-call name="mantle.party.ContactServices.get#PartyContactInfoList" out-map="customerShippingInfo"
                                              in-map="[partyId:customerShipToDetail.partyId, postalContactMechPurposeId:'PostalShippingDest']"/>
                            </actions>
                            <widgets>
                                <container-box><box-header title="Ship To Address"/>
                                    <box-toolbar>
                                        <container-dialog id="SelectShipToAddress" button-text="Select" condition="orderPartInfo.partEditable">
                                            <form-single name="SelectShipToForm" transition="setOrderBillingShippingInfo" map="orderPartInfo.orderPart">
                                                <field name="orderId"><default-field><hidden/></default-field></field>
                                                <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                                                <field name="paymentMethodId"><default-field><hidden/></default-field></field>
                                                <!-- <field name="shippingTelecomContactMechId"><default-field><hidden/></default-field></field> -->
                                                <field name="shippingPostalContactMechId" from="orderPart.postalContactMechId">
                                                    <conditional-field title="Shipping Address" condition="orderPartInfo.partEditable"><drop-down>
                                                        <list-options list="customerShippingInfo.postalAddressList" key="${postalContactMechId}" text="PostalAddressInfoTemplate"/>
                                                    </drop-down></conditional-field>
                                                    <default-field><hidden/></default-field>
                                                </field>
                                                <!-- Not required for digital / subscription products. Can add back in if used for mixed physical / digital goods use case.
                                                <field name="carrierAndShipmentMethod">
                                                    <conditional-field title="Shipment Method" condition="orderPartInfo.partEditable">
                                                        <drop-down no-current-selected-key="${orderPart.carrierPartyId ? orderPart.carrierPartyId + ':' + orderPart.shipmentMethodEnumId : ''}">
                                                            <list-options list="shippingOptions" key="${carrierPartyId}:${shipmentMethodEnumId}"
                                                                          text="${description ? description : (carrierPartyId != '_NA_' ? (carrierName + ' - ') : '') + shipmentMethodDescription}${shippingTotal != null ? ' ' + ec.l10n.formatCurrency(shippingTotal, orderHeader.currencyUomId) : ''}"/>
                                                            <dynamic-options transition="getShippingOptions"/>
                                                        </drop-down>
                                                    </conditional-field>
                                                    <default-field title="Shipment Method">
                                                        <display text="${orderPartInfo.shipmentMethodEnum?.description ?: ''}${orderPartInfo.carrierPartyDetail ? ' - ' + ec.resource.expand('PartyNameTemplate', null, orderPartInfo.carrierPartyDetail) : ''}"/></default-field>
                                                </field>
                                                -->
                                                <field name="submitButton">
                                                    <conditional-field condition="orderPartInfo.partEditable" title="Save">
                                                        <submit/></conditional-field>
                                                    <default-field><ignored/></default-field>
                                                </field>
                                            </form-single>
                                        </container-dialog>
                                        <dynamic-dialog id="UpdatePostalInfo" button-text="Edit" transition="UpdateContactInfo"
                                                        width="800" condition="orderPartInfo.partEditable &amp;&amp; contactInfo"
                                                        parameter-map="[partyId:customerShipToDetail.partyId, postalContactMechId:contactInfo.postalContactMechId,
                                                postalContactMechPurposeId:contactInfo.postalContactMechPurposeId, orderId:orderId]"/>
                                        <dynamic-dialog id="AddPostalInfo" button-text="Add" transition="UpdateContactInfo"
                                                        width="800" condition="orderPartInfo.partEditable"
                                                        parameter-map="[partyId:customerShipToDetail.partyId, postalContactMechPurposeId:'PostalShippingDest',
                                                        telecomContactMechPurposeId:'PhoneShippingDest', emailContactMechPurposeId:'EmailShippingDest', orderId:orderId, postalContactMechId:null]"/>
                                    </box-toolbar>
                                    <box-body>
                                        <label text="Please select an address using the 'Select' button.
                                        If none are listed add a new address." condition="!contactInfo" type="i"/>
                                        <text type="html,vuet,qvt" location="component://Sales/template/ContactInfo.html.gstring"/>
                                    </box-body>
                                </container-box>

                                <!-- Address validation to be implemented later. This source is from OrderDetail.xml.
                                <container>
                                    <label text="Trust: ${contactInfo.postalTrustLevelEnum?.description ?: 'New'}${contactInfo.postalContactMech.validateMessage?'*':''}"
                                           type="strong" tooltip="${contactInfo.postalContactMech.validateMessage?:''}"/>
                                    <link url="validateAddress" text="Validate"
                                          parameter-map="[orderId:orderId, partyId:customerPartyId, facilityId:contactInfo.facilityId, contactMechId:contactInfo.postalContactMechId]"
                                          condition="!contactInfo.postalContactMech.trustLevelEnumId || contactInfo.postalContactMech.trustLevelEnumId == 'CmtlNew'"/>
                                </container>
                                -->

                        </widgets></section>
                        <!-- Not required for subscriptions
                        <section name="SetShippingMethod">
                            <widgets>
                                <form-single name="SelectShipMethodForm" transition="setOrderBillingShippingInfo" map="orderPartInfo.orderPart">
                                    <field name="orderId"><default-field><hidden/></default-field></field>
                                    <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                                    <field name="carrierAndShipmentMethod">
                                        <conditional-field title="Shipment Method" condition="orderPartInfo.partEditable">
                                            <drop-down submit-on-select="true" no-current-selected-key="${orderPart.carrierPartyId ? orderPart.carrierPartyId + ':' + orderPart.shipmentMethodEnumId : ''}">
                                                <list-options list="shippingOptions" key="${carrierPartyId}:${shipmentMethodEnumId}"
                                                              text="${description ? description : (carrierPartyId != '_NA_' ? (carrierName + ' - ') : '') + shipmentMethodDescription}${shippingTotal != null ? ' ' + ec.l10n.formatCurrency(shippingTotal, orderHeader.currencyUomId) : ''}"/>
                                                <dynamic-options transition="getShippingOptions"/>
                                            </drop-down>
                                        </conditional-field>
                                        <default-field title="Shipment Method">
                                            <display text="${orderPartInfo.shipmentMethodEnum?.description ?: ''}${orderPartInfo.carrierPartyDetail ? ' - ' + ec.resource.expand('PartyNameTemplate', null, orderPartInfo.carrierPartyDetail) : ''}"/></default-field>
                                    </field>

                                </form-single>
                            </widgets>
                        </section>
                        -->
                    </box-body>
                </container-box>
                <container-box>
                    <box-header title="Agreement (Contract) Information"></box-header>
                    <box-body>
                        <form-single name="AgreementForm" transition="updateOrderPart">
                            <field name="orderId"><default-field><hidden/></default-field></field>
                            <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                            <field name="validFromDate" from="orderPart.validFromDate"><default-field title="Effective Date"><date-time type="date"/></default-field></field>
                            <field name="validThruDate" from="orderPart.validThruDate"><default-field title="End Date"><date-time type="date"/></default-field></field>
                            <field name="partName" from="orderPart.partName"><default-field><text-line size="20"/></default-field></field>
                            <field name="submitButton">
                                <conditional-field condition="orderPartInfo.partEditable" title="Update"><submit/></conditional-field>
                                <default-field><ignored/></default-field>
                            </field>
                            <field-layout>
                                <field-col-row>
                                    <field-col><field-ref name="validFromDate"/></field-col>
                                    <field-col><field-ref name="validThruDate"/></field-col>
                                    <field-col><field-ref name="partName"/></field-col>
                                    <field-col><field-ref name="submitButton"/></field-col>
                                </field-col-row>
                                <fields-not-referenced/>
                            </field-layout>
                        </form-single>
                        <container-box>
                            <box-header title="Other Parties"/>
                            <box-toolbar>
                                <container-dialog id="AddPartPartyDialog" button-text="Add Party" condition="orderPartInfo.partEditable">
                                    <form-single name="CreateOrderPartParty" transition="createOrderPartParty" map="orderPart">
                                        <field name="orderId"><default-field><hidden/></default-field></field>
                                        <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                                        <field name="partyId"><default-field title="Party"><drop-down>
                                            <dynamic-options transition="searchPartyList" server-search="true" min-length="2"/></drop-down>
                                        </default-field></field>
                                        <field name="roleTypeId"><default-field title="Role">
                                            <drop-down><entity-options key="${roleTypeId}" text="${description}">
                                                <entity-find entity-name="mantle.party.RoleGroupMemberAndType" cache="true">
                                                    <econdition field-name="roleGroupEnumId" value="RgpOrder"/>
                                                    <order-by field-name="description"/></entity-find>
                                            </entity-options></drop-down>
                                        </default-field></field>
                                        <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                                    </form-single>
                                </container-dialog>
                            </box-toolbar>
                            <box-body>
                                <section-iterate name="OrderPartRoleSection" list="orderPartInfo.orderPartPartyList" entry="orderPartParty"><widgets>
                                    <container>
                                        <link url="deleteOrderPartParty" text="X" link-type="hidden-form-link"
                                              parameter-map="[orderId:orderPartParty.orderId, orderPartSeqId:orderPartParty.orderPartSeqId,
                                        partyId:orderPartParty.partyId, roleTypeId:orderPartParty.roleTypeId]"/>
                                        <label text="${orderPartParty.description}: " type="strong"/>
                                        <label text="PartyNameTemplate" text-map="orderPartParty" type="span"/>
                                        <!-- TODO: would be nice to have a general editParty screen to link to from here and elsewhere -->
                                    </container>
                                </widgets></section-iterate>
                            </box-body>
                        </container-box>
                    </box-body>
                </container-box>
            </row-col>
            <row-col lg="6">
                <container-box>
                    <box-header title="Bill To Customer: ${ec.resource.expand('PartyNameOnlyTemplate','',customerBillToDetail)}"/>
                    <box-toolbar>
                        <container-dialog id="ChangeBillToDialog" button-text="Change Bill To" condition="orderPartInfo.partEditable">
                            <form-single name="ChangeBillToForm" transition="updateBillToParty" map="orderPart">
                                <!-- Set role type to bill to for this section -->
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                                <field name="currentBillToPartyId"><default-field><hidden default-value="customerBillToDetail.partyId"/></default-field></field>
                                <field name="newBillToPartyId"><default-field title="Party"><drop-down>
                                    <dynamic-options transition="searchPartyList" server-search="true" min-length="0"/></drop-down>
                                </default-field></field>
                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                        </box-toolbar>
                    <box-body>
                        <section name="CurrentBillingAddress">
                            <actions>
                                <entity-find-one entity-name="mantle.order.OrderPartContactMech" value-field="curBillToContactMech">
                                    <field-map field-name="orderId" from="orderPart.orderId"/>
                                    <field-map field-name="orderPartSeqId" from="orderPart.orderPartSeqId"/>
                                    <field-map field-name="contactMechPurposeId" value="PostalBilling"/>
                                </entity-find-one>
                                <if condition="curBillToContactMech">
                                    <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="curBillToInfo"
                                                  in-map="[partyId:customerBillToDetail.partyId, postalContactMechId:curBillToContactMech.contactMechId]"/>
                                    <!--<set field="contactInfo" from="curBillToInfo"/>-->
                                </if>
                                <!-- addresses on profile -->
                                <service-call name="mantle.party.ContactServices.get#PartyContactInfoList" out-map="customerBillingInfo"
                                              in-map="[partyId:customerBillToDetail.partyId, postalContactMechPurposeId:'PostalBilling']"/>
                            </actions>
                            <widgets>
                                <container-box><box-header title="Bill To Address"/>
                                    <box-toolbar>
                                        <container-dialog id="SelectBillToAddress" button-text="Select" condition="orderPartInfo.partEditable">
                                            <form-single name="SetBillingInfoForm" transition="setBillToContactMech" map="orderPartInfo.orderPart">
                                                <field name="orderId"><default-field><hidden/></default-field></field>
                                                <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                                                <field name="paymentMethodId"><default-field><hidden/></default-field></field>
                                                <field name="billToPostalContactMechId" from="curBillToContactMech?.contactMechId">
                                                    <conditional-field title="Billing Address" condition="orderPartInfo.partEditable"><drop-down>
                                                        <list-options list="customerBillingInfo.postalAddressList" key="${postalContactMechId}" text="PostalAddressInfoTemplate"/>
                                                    </drop-down></conditional-field>
                                                    <default-field><hidden/></default-field>
                                                </field>
                                                <field name="submitButton">
                                                    <conditional-field condition="orderPartInfo.partEditable" title="Set Billing Address">
                                                        <submit/></conditional-field>
                                                    <default-field><ignored/></default-field>
                                                </field>
                                            </form-single>
                                        </container-dialog>
                                        <dynamic-dialog id="UpdatePostalInfo" button-text="Edit" transition="UpdateContactInfo"
                                                        width="800" condition="orderPartInfo.partEditable &amp;&amp; contactInfo"
                                                        parameter-map="[partyId:customerBillToDetail.partyId, postalContactMechId:contactInfo.postalContactMechId,
                                                postalContactMechPurposeId:contactInfo.postalContactMechPurposeId, orderId:orderId]"/>
                                        <dynamic-dialog id="AddPostalInfo" button-text="Add" transition="UpdateContactInfo"
                                                        width="800" condition="orderPartInfo.partEditable"
                                                        parameter-map="[partyId:customerBillToDetail.partyId, postalContactMechPurposeId:'PostalBilling',
                                    telecomContactMechPurposeId:'PhoneBilling', emailContactMechPurposeId:'EmailBilling', orderId:orderId, postalContactMechId:null]"/>

                                    </box-toolbar>
                                    <box-body>
                                        <label text="Please select an address using the 'Select' button.
                                        If none are listed add a new address." condition="!curBillToInfo" type="i"/>
                                        <section name="BillToAddressDisplay" condition="curBillToInfo">
                                            <widgets>
                                                <text type="html,vuet,qvt" location="component://Sales/template/BillToContactInfo.html.gstring"/>
                                            </widgets>
                                        </section>
                                    </box-body>
                                </container-box>

                                <!-- Address validation to be implemented later. This source is from OrderDetail.xml.
                                <container>
                                    <label text="Trust: ${contactInfo.postalTrustLevelEnum?.description ?: 'New'}${contactInfo.postalContactMech.validateMessage?'*':''}"
                                           type="strong" tooltip="${contactInfo.postalContactMech.validateMessage?:''}"/>
                                    <link url="validateAddress" text="Validate"
                                          parameter-map="[orderId:orderId, partyId:customerPartyId, facilityId:contactInfo.facilityId, contactMechId:contactInfo.postalContactMechId]"
                                          condition="!contactInfo.postalContactMech.trustLevelEnumId || contactInfo.postalContactMech.trustLevelEnumId == 'CmtlNew'"/>
                                </container>
                                -->

                            </widgets></section>
                    </box-body>
                </container-box>
                <!-- Payment Information -->
                <container-box>
                    <box-header title="Payment Information"/>
                    <box-toolbar>
                        <container-dialog id="AddPaymentInfo" button-text="Add Payment" condition="orderPartInfo.partEditable">
                            <form-single name="AddPaymentForm" transition="addOrderPartPayment" focus-field="paymentMethodId">
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="orderPartSeqId" from="orderPartInfo.orderPart.orderPartSeqId"><default-field><hidden/></default-field></field>
                                <field name="paymentMethodId"><default-field title="Payment Method"><drop-down allow-empty="true">
                                    <entity-options key="${paymentMethodId}" text="PaymentMethodDetailTemplate">
                                        <entity-find entity-name="mantle.account.method.PaymentMethodDetail">
                                            <date-filter/>
                                            <!-- TODO: Refactor to ONLY use customerBillToPartyId if it exists for payment methods -->
                                            <econditions combine="or">
                                                <econdition field-name="ownerPartyId" from="customerPartyId"/>
                                                <econdition field-name="ownerPartyId" from="customerBillToPartyId" ignore-if-empty="true"/>
                                            </econditions>
                                        </entity-find></entity-options>
                                </drop-down></default-field></field>
                                <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </box-toolbar>
                    <box-body>
                        <section-iterate name="PaymentInfoListSection" list="orderPartInfo.partPaymentInfoList" entry="partPaymentInfo"><actions>
                            <set field="methodInfo" from="partPaymentInfo"/>
                            <entity-find entity-name="mantle.account.method.PaymentGatewayResponse" list="gatewayResponseList">
                                <econdition field-name="paymentId" from="partPaymentInfo.partPayment.paymentId"/>
                                <order-by field-name="-transactionDate"/></entity-find>
                        </actions><widgets>
                            <container>
                                <label text="${partPaymentInfo.paymentMethodTypeEnum?.description?:(partPaymentInfo.paymentInstrumentEnum?.description?:'')} (${partPaymentInfo.paymentTypeEnum?.description}) ${ec.l10n.formatCurrency(partPaymentInfo.partPayment.amount, partPaymentInfo.partPayment.amountUomId)}" type="strong"/>
                                <label text=" - Status: ${partPaymentInfo.statusItem?.description}" type="strong"/>
                                <label text=" - Due: ${ec.l10n.format(partPaymentInfo.partPayment.dueDate, 'yyyy-MM-dd')}" type="strong"
                                       condition="partPaymentInfo.partPayment.dueDate"/>
                                <container-dialog id="UpdatePaymentDialog" button-text="Update"
                                                  condition="orderPartInfo.partEditable &amp;&amp; partPaymentInfo.partPayment.statusId in ['PmntProposed', 'PmntPromised']">
                                    <form-single name="UpdatePaymentForm" transition="updatePayment"
                                                 map="partPaymentInfo.partPayment" extends="AddPaymentForm">
                                        <field name="orderId"><default-field><hidden/></default-field></field>
                                        <field name="paymentId"><default-field><hidden/></default-field></field>
                                        <field name="amount" from=""><default-field><text-line size="10" format="0.00"/></default-field></field>
                                        <field name="settlementTermId"><default-field><ignored/></default-field></field>
                                        <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                                    </form-single>
                                </container-dialog>
                                <container-dialog id="GatewayAuthorizeDialog" button-text="Gateway Authorize" condition="partPaymentInfo.partPayment.statusId in ['PmntPromised', 'PmntProposed', 'PmntDeclined']">
                                    <form-single name="GatewayAuthorizeForm" map="partPaymentInfo.partPayment" transition="gatewayAuthorize">
                                        <field name="orderId"><default-field><hidden/></default-field></field>
                                        <field name="paymentId"><default-field><hidden/></default-field></field>
                                        <field name="cardSecurityCode"><default-field><text-line size="4"/></default-field></field>
                                        <field name="submitButton"><default-field title="Authorize"><submit/></default-field></field>
                                    </form-single>
                                </container-dialog>
                                <container-dialog id="GatewayHistoryDialog" button-text="Gateway History" condition="gatewayResponseList" width="900">
                                    <form-list name="GatewayResponseList" skip-form="true"
                                               extends="component://SimpleScreens/screen/SimpleScreens/Accounting/Payment/EditPayment.xml#GatewayResponseList"/>
                                </container-dialog>
                                <!-- TODO: Use this section if we want the ability to cancel a CC payment (e.g., to change to a different CC)
                                <container>
                                    <link url="editPayment" text="Edit Payment ${partPaymentInfo.partPayment.paymentId}" link-type="anchor"
                                          parameter-map="[paymentId:partPaymentInfo.partPayment.paymentId]"/>
                                    <link url="editPaymentMethod" text="Edit ${partPaymentInfo.paymentMethod?.description ?: 'Payment Method ' + partPaymentInfo.partPayment.paymentMethodId}"
                                          parameter-map="[paymentMethodId:partPaymentInfo.partPayment.paymentMethodId]" link-type="anchor"
                                          condition="partPaymentInfo.partPayment.paymentMethodId != null"/>
                                </container>
                                -->
                                <text type="html,vuet,qvt" location="component://SimpleScreens/template/party/PaymentMethodInfo.html.gstring"/>
                                <label text="CIM ID: ${methodInfo.paymentMethod.gatewayCimId}" type="div" condition="methodInfo.paymentMethod?.gatewayCimId"/>
                                <label text="Gateway: ${methodInfo.paymentMethod.gatewayConfig?.description}" type="div" condition="methodInfo.paymentMethod?.paymentGatewayConfigId"/>
                            </container>
                        </widgets></section-iterate>
                        <form-single name="EditPartForm" transition="updateOrderPart" map="orderPart">
                            <field name="orderId"><default-field><hidden/></default-field></field>
                            <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                            <field name="settlementTermId"><default-field title="Payment Terms">
                                <drop-down submit-on-select="true" allow-empty="true"><entity-options key="${settlementTermId}" text="${description}">
                                    <entity-find entity-name="mantle.account.invoice.SettlementTermAndEnumMember">
                                        <econdition field-name="enumGroupEnumId" value="EngPaymentTermType"/>
                                        <order-by field-name="description"/>
                                    </entity-find>
                                </entity-options></drop-down>
                            </default-field></field>
                        </form-single>
                    </box-body>
                </container-box>
            </row-col>
        </container-row>
        <subscreens-panel id="BottomPanel" type="tab"/>
    </widgets>
</screen>